name: Deploy Render

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      strict_readiness:
        description: 'Fail and rollback if /health/ready is not 200 in time'
        required: false
        default: 'false'

permissions:
  contents: read

concurrency:
  group: deploy-render
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
      RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
      RENDER_HEALTHCHECK_URL: ${{ secrets.RENDER_HEALTHCHECK_URL }}
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      STRICT_READINESS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.strict_readiness || 'false' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "Missing secret: NEON_DATABASE_URL"
            exit 1
          fi
          if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "Missing secret: RENDER_DEPLOY_HOOK_URL"
            exit 1
          fi
          if [ -z "$RENDER_HEALTHCHECK_URL" ]; then
            echo "Missing secret: RENDER_HEALTHCHECK_URL"
            exit 1
          fi
          if [ -z "$RENDER_API_KEY" ]; then
            echo "Missing secret: RENDER_API_KEY"
            exit 1
          fi
          if [ -z "$RENDER_SERVICE_ID" ]; then
            echo "Missing secret: RENDER_SERVICE_ID"
            exit 1
          fi

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run DB migrations (Neon)
        run: pnpm run db:migrate:ci

      - name: Verify migration status
        run: pnpm run db:migrate:status:ci

      - name: Trigger Render deploy
        run: curl -fsS -X POST "$RENDER_DEPLOY_HOOK_URL"

      - name: Wait for deployment readiness
        id: readiness
        run: |
          echo "Checking $RENDER_HEALTHCHECK_URL (strict=$STRICT_READINESS) ..."
          ready=false
          for i in $(seq 1 12); do
            status_code=$(curl -s -o /tmp/health_response.json -w "%{http_code}" "$RENDER_HEALTHCHECK_URL" || true)
            if [ "$status_code" = "200" ]; then
              echo "Service ready."
              cat /tmp/health_response.json
              ready=true
              break
            fi
            echo "Attempt $i/12: healthcheck returned $status_code"
            sleep 10
          done
          echo "ready=$ready" >> "$GITHUB_OUTPUT"
          if [ "$ready" != "true" ]; then
            echo "Readiness not confirmed in time."
            cat /tmp/health_response.json || true
          fi

      - name: Trigger automatic rollback
        if: steps.readiness.outputs.ready != 'true' && env.STRICT_READINESS == 'true'
        run: |
          curl -fsS \
            -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/rollback"

      - name: Fail deploy when strict readiness check fails
        if: steps.readiness.outputs.ready != 'true' && env.STRICT_READINESS == 'true'
        run: exit 1
